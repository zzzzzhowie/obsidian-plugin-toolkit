import esbuild from "esbuild";
import process from "process";
import builtins from "builtin-modules";
import fs from "fs";
import { join, resolve } from "path";
import { symlinkSync, cpSync, existsSync, statSync, rmSync } from "fs";

// Read version from package.json
const packageJson = JSON.parse(fs.readFileSync("./package.json", "utf8"));

// Read target from tsconfig.json to keep esbuild and TS in sync
// Note: tsconfig.json may contain comments, so we'll strip them before parsing
const tsconfigContent = fs.readFileSync("./tsconfig.json", "utf8")
	.replace(/\/\*[\s\S]*?\*\//g, '') // Remove /* */ comments
	.replace(/\/\/.*$/gm, ''); // Remove // comments
const tsconfig = JSON.parse(tsconfigContent);
const tsTarget = (tsconfig?.compilerOptions?.target ?? "ES2020").toLowerCase();

const banner =
`/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
Image Converter Plugin v${packageJson.version}
if you want to view the source, please visit the github repository of this plugin
*/
`;

const prod = (process.argv[2] === "production");

// Build configuration optimized for Obsidian Image Converter Plugin
const buildConfig = {
	banner: {
		js: banner,
	},
	entryPoints: ["./src/main.ts"],
	bundle: true,
	external: [
		// Obsidian and Electron APIs
		"obsidian",
		"electron",
		// CodeMirror (provided by Obsidian)
		"@codemirror/autocomplete",
		"@codemirror/collab",
		"@codemirror/commands",
		"@codemirror/language",
		"@codemirror/lint",
		"@codemirror/search",
		"@codemirror/state",
		"@codemirror/view",
		"@lezer/common",
		"@lezer/highlight",
		"@lezer/lr",
		// Node.js built-in modules
		...builtins,
	],
	format: "cjs",

	// Target derived from tsconfig.json
	target: tsTarget,

	logLevel: prod ? "error" : "info",
	sourcemap: prod ? false : "inline",
	treeShaking: true,

	// Minification strategy for production
	minify: prod,
	minifyWhitespace: prod,
	minifyIdentifiers: prod,
	minifySyntax: prod,

	// Debugging aids
	keepNames: !prod,

	// Production optimizations
	drop: prod ? ["debugger"] : [],

	outfile: "build/main.js",
	platform: "node",
	tsconfig: "tsconfig.json", // Make esbuild pick up paths and TS settings consistently

	// Required by UTIF.js library
	define: {
		"process.env.NODE_ENV": prod ? '"production"' : '"development"',
	},

	metafile: false, // Disabled as per user request
};

// Helper function to copy files to build
async function copyToBuild() {
	// Ensure build directory exists
	if (!fs.existsSync('build')) {
		fs.mkdirSync('build');
	}
	
	// Copy manifest.json
	if (fs.existsSync('manifest.json')) {
		fs.copyFileSync('manifest.json', 'build/manifest.json');
	}
	
	// Copy styles.css if it exists
	if (fs.existsSync('styles.css')) {
		fs.copyFileSync('styles.css', 'build/styles.css');
	}
}

// Sync plugin to Obsidian plugins directory
function syncToObsidian(isDev) {
	const OBSIDIAN_PLUGINS_DIR = '/Users/yeyan1996/Library/Mobile Documents/iCloud~md~obsidian/Documents/default/.obsidian/plugins';
	const distDir = 'image-converter'; // Use manifest id as directory name
	const packagePath = process.cwd();
	const sourcePath = resolve(packagePath, 'build');
	const targetPath = join(OBSIDIAN_PLUGINS_DIR, distDir);
	
	if (!existsSync(OBSIDIAN_PLUGINS_DIR)) {
		console.warn(`âš ï¸  Obsidian plugins directory does not exist: ${OBSIDIAN_PLUGINS_DIR}`);
		return;
	}
	
	if (!existsSync(sourcePath)) {
		console.warn(`âš ï¸  Source directory does not exist: ${sourcePath}`);
		return;
	}
	
	// Remove existing target (symlink or directory)
	if (existsSync(targetPath)) {
		try {
			const stat = statSync(targetPath);
			if (stat.isSymbolicLink()) {
				rmSync(targetPath);
			} else if (stat.isDirectory()) {
				rmSync(targetPath, { recursive: true, force: true });
			}
		} catch (error) {
			console.warn(`âš ï¸  Failed to remove existing target: ${error.message}`);
		}
	}
	
	// Create symlink (dev) or copy (build)
	try {
		if (isDev) {
			symlinkSync(sourcePath, targetPath, 'dir');
			console.log(`âœ“ Symlinked ${distDir} -> Obsidian plugins`);
		} else {
			cpSync(sourcePath, targetPath, { recursive: true });
			console.log(`âœ“ Copied ${distDir} -> Obsidian plugins`);
		}
	} catch (error) {
		console.error(`âœ— Failed to ${isDev ? 'symlink' : 'copy'} ${distDir}:`, error.message);
	}
}

// Create build context
const context = await esbuild.context(buildConfig);


if (prod) {
	try {
		console.log("\nğŸš€ Building Image Converter Plugin...");
		console.log(`ğŸ“Œ Version: ${packageJson.version}`);
		
		await context.rebuild();
		
		// Copy additional files to build
		await copyToBuild();
		
		// Sync to Obsidian plugins directory (copy mode)
		syncToObsidian(false);
		
		// Meta file generation removed as per user request
		
		console.log("âœ… Production build completed in build/\n");
		
		await context.dispose();
		process.exit(0);
	} catch (error) {
		console.error("\nâŒ Build failed:", error.message);
		await context.dispose();
		process.exit(1);
	}
} else {
	// Development mode with file watching
	try {
		await context.watch();
		
		// Copy files to build in dev mode too
		await copyToBuild();
		
		// Sync to Obsidian plugins directory (symlink mode)
		syncToObsidian(true);
		
		console.log("\nğŸ–¼ï¸  Image Converter Plugin - Development Mode");
		console.log("=".repeat(50));
		console.log("ğŸ“Œ Version:    " + packageJson.version);
		console.log("ğŸ¯ Target:     " + tsTarget.toUpperCase());
		console.log("ğŸ“ Entry:      ./src/main.ts");
		console.log("ğŸ“¤ Output:     ./build/");
		console.log("\nğŸ‘€ Watching for changes... (Ctrl+C to stop)\n");
		
		// Handle graceful shutdown
		process.on('SIGINT', async () => {
			console.log("\nğŸ›‘ Stopping development server...");
			await context.dispose();
			process.exit(0);
		});
	} catch (error) {
		console.error("âŒ Failed to start development mode:", error);
		process.exit(1);
	}
}
